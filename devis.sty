%% Informations générales
\NeedsTeXFormat{LaTeX2e}[1999/01/01]
\ProvidesPackage{devis}[2010/11/23]

\RequirePackage{units}
\RequirePackage{fancyhdr}
\RequirePackage{fp}
\RequirePackage[french]{babel}
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\RequirePackage[a4paper]{geometry}
\RequirePackage{tango}
%\RequirePackage{eurofont}  %Saisir €
\RequirePackage{eurosym}  %\euro{} \EUR{12} 
\RequirePackage{xstring}  
\RequirePackage{graphics}


\def\TVA{20}	% Taux de la TVA, 0 pour les auto-entrepreneur
%\def\DevisNum{\StrBefore{\jobname}{\textunderscore}} %Si les fichiers sont de la forme NUM-DEVIS_blabla
\def\DevisNum{\StrLeft{\jobname}{7}} %Si les fichiers sont de la forme YYYY-NN

\def\TotalHT{0}
\def\TotalTVA{0}
\def\NetAPayer{0}
\def\Acompte{0}

\newcommand{\tva}[1]{ \def\TVA{#1} } 
\newcommand{\societe}[1]{ \def\Societe{#1} } 
\newcommand{\client}[1]{ \def\Client{#1} }
\newcommand{\basdepage}[1]{ \cfoot{{\rule{\linewidth}{.5pt}\\#1} }}

\newcommand{\rib}[4]{%
	\def\RibBanque{#1}
	\def\RibGuichet{#2}
	\def\RibCompte{#3}
	\def\RibCle{#4}
}

\newcommand{\iban}[1]{ \def\Iban{#1} }
\newcommand{\bic}[1]{ \def\Bic{#1} }

\newcommand{\devis}{%
	\parbox[b]{0.4\textwidth}{\Societe}\hfill
	\parbox[b]{0.4\textwidth}{
		\colorbox{LightOrange}{
			\begin{minipage}{0.35\textwidth}
				\begin{center}
					{\Large \textbf{Devis \no: \DevisNum}}\\
					\DevisLieu, le \today 
				\end{center}
			\end{minipage}
		}
		\vspace*{1cm}
	}

	{\addtolength{\leftskip}{9.5cm} %in ERT
		  \Client\\

	} %in ERT

	\vspace*{1cm}
	\textbf{Objet : \DevisObjet \\}

	\textnormal{\DevisDescr}

	\vspace*{0.3cm}

	\begin{center}
	  \begin{tabular}{p{8cm} c c r}
		  \textbf{Désignation} & \textbf{Prix unitaire}  & \textbf{Quantité} & \textbf{Montant}  \\
		  \hline
			\AfficheResultat{}
		\end{tabular}
	\end{center}

	\vspace*{0.2cm}
	Devis valable 1 mois à compter de sa date d'émission. Toute modification de
	quelque nature que ce soit est susceptible d'entraîner une mise à jour de ce
	devis.

	\ifthenelse{\equal{\DevisAcompte}{oui}}{
	Pour toute commande de votre part, merci de me retourner le double de ce devis signé 
	accompagné d'un acompte s'élevant à 40\% du montant total de la commande soit : \Acompte~\euro.
	}{
	Pour toute commande de votre part, merci de me retourner le double de ce devis signé.
 }

	\vspace*{0.3cm}

	\begin{minipage}{0.35\textwidth}
		Bon pour accord le :\\
		Signature
	\end{minipage}

	\vspace*{1.5cm}
	{\tiny
	Le paiement sera à effectuer au plus tard au trentième jour suivant la date de réception de la facture (cf : c. com. art L.  441-6, al.2 modifié de la loi du 15 mai 2001). En cas de retard de paiement, une pénalité fixée à 15\% du montant total de la facture, par mois de retard entamé, est exigible sans rappel le jour suivant la date limite de règlement. Mention obligatoire. Lutte contre les retards de paiement / Article 53 de la Loi NRE.
  \par %Pour forcer le calcul de l'interligne
  }

}

\newcommand{\AjouterProduit}[3]{%	Arguments : Désignation, quantité, prix unitaire HT
	\FPround{\prix}{#3}{2}
	\FPeval{\montant}{#2 * #3}
	\FPround{\montant}{\montant}{2}
	\FPadd{\TotalHT}{\TotalHT}{\montant}
	
	\eaddto\ListeProduits{#1	&	\prix	&	#2	&	\montant \cr}
}

\newcommand{\AfficheResultat}{%
	\ListeProduits
	
	\FPeval{\TotalTVA}{\TotalHT * \TVA / 100}
	\FPadd{\TotalTTC}{\TotalHT}{\TotalTVA}
	\FPadd{\NetAPayer}{\NetAPayer}{\TotalTTC}
	\FPeval{\Acompte}{\TotalTTC * 40 / 100 }
	\FPround{\TotalHT}{\TotalHT}{2}
	\FPround{\TotalTVA}{\TotalTVA}{2}
	\FPround{\TotalTTC}{\TotalTTC}{2}
	\FPround{\Acompte}{\Acompte}{2}
	\FPround{\NetAPayer}{\NetAPayer}{2}
	\global\let\TotalHT\TotalHT
	\global\let\TotalTVA\TotalTVA
	\global\let\TotalTTC\TotalTTC
	\global\let\NetAPayer\NetAPayer
	\global\let\Acompte\Acompte
	
	\cr \hline
	Total HT			& & &	\TotalHT~\euro \cr
	\ifthenelse{\equal{\TVA}{0}}{
		\cr \omit \span TVA non applicable, art. 293 B du code des impôts. \cr \cr
	}{
		TVA \TVA~\% 		& & &	\TotalTVA	\cr
	}
	\hline \hline
	& \omit \span \textbf{Total TTC}	&	\TotalTTC~\euro \cr\cr
}

\newcommand*\eaddto[2]{% version développée de \addto
   \edef\tmp{#2}%
   \expandafter\addto%
   \expandafter#1%
   \expandafter{\tmp}%
} 

\newcommand{\ListeProduits}{}


\geometry{verbose,tmargin=4em,bmargin=6em,lmargin=6em,rmargin=6em}
\setlength{\parindent}{0pt}
\setlength{\parskip}{1ex plus 0.5ex minus 0.2ex}

\thispagestyle{fancy}
\pagestyle{fancy}
\setlength{\parindent}{0pt}

\renewcommand{\headrulewidth}{0pt}

\endinput
%" vim:syntax=tex ts=2 

